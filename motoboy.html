<script type="module">
import { db } from "./firebase.js";
import { 
  collection, 
  addDoc, 
  onSnapshot,
  query,
  where,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let motoboyId = null;

window.ficarOnline = async function(){

  const docRef = await addDoc(collection(db, "motoboys"), {
    nome: document.getElementById("nome").value,
    zona: document.getElementById("zona").value,
    online: true,
    recusas: 0,
    ultimaRecusa: 0
  });

  motoboyId = docRef.id;

  ouvirPedidos();
};

function ouvirPedidos(){

  const q = query(
    collection(db, "pedidos"),
    where("motoboyId", "==", motoboyId),
    where("status", "==", "enviado")
  );

  onSnapshot(q, (snapshot) => {
    snapshot.forEach(docSnap => {

      const pedido = docSnap.data();

      document.getElementById("info").innerHTML = `
        <h3>Novo Pedido</h3>
        Cliente: ${pedido.cliente}<br>
        Endere√ßo: ${pedido.endereco}<br><br>
        <button onclick="aceitar('${docSnap.id}')">Aceitar</button>
        <button onclick="recusar('${docSnap.id}')">Recusar</button>
      `;
    });
  });
}

window.aceitar = async function(pedidoId){
  await updateDoc(doc(db, "pedidos", pedidoId), {
    status: "aceito"
  });

  alert("Pedido aceito!");
}

window.recusar = async function(pedidoId){

  const agora = Date.now();

  const motoRef = doc(db, "motoboys", motoboyId);

  await updateDoc(motoRef, {
    recusas: 1,
    ultimaRecusa: agora
  });

  await updateDoc(doc(db, "pedidos", pedidoId), {
    status: "aguardando",
    motoboyId: null
  });

  alert("Pedido recusado!");
}
</script>
